<script>
  // Listen for dark mode changes from storybook-dark-mode addon
  (function() {
    function setupDarkModeListener() {
      var channel = window.__STORYBOOK_ADDONS_CHANNEL__;
      if (!channel) {
        console.log('[DarkMode] Channel not available yet');
        return false;
      }

      // Check if listener already added
      if (window.__DARK_MODE_LISTENER_ADDED__) {
        return true;
      }

      console.log('[DarkMode] Setting up listener on channel:', channel);

      // Try using the on method
      if (typeof channel.on === 'function') {
        channel.on('DARK_MODE', function(isDark) {
          console.log('[DarkMode] Event received:', isDark);
          document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
        });
        window.__DARK_MODE_LISTENER_ADDED__ = true;
        console.log('[DarkMode] Listener added successfully');
        return true;
      }

      // Fallback: try addListener
      if (typeof channel.addListener === 'function') {
        channel.addListener('DARK_MODE', function(isDark) {
          console.log('[DarkMode] Event received (addListener):', isDark);
          document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
        });
        window.__DARK_MODE_LISTENER_ADDED__ = true;
        console.log('[DarkMode] Listener added via addListener');
        return true;
      }

      console.log('[DarkMode] Could not add listener, channel methods:', Object.keys(channel));
      return false;
    }

    // Try immediately
    if (!setupDarkModeListener()) {
      // Retry with interval
      var attempts = 0;
      var interval = setInterval(function() {
        attempts++;
        if (setupDarkModeListener() || attempts > 100) {
          clearInterval(interval);
          if (attempts > 100) {
            console.warn('[DarkMode] Failed to set up listener after 100 attempts');
          }
        }
      }, 50);
    }
  })();
</script>
